# ğŸ›°ï¸ NetDiag-LLMï¼šç”¨ eBPF è®© Token æŒ‰ç½‘é€ŸåŒ€é€Ÿç”Ÿæˆ

> **æŠŠç½‘ç»œè¯Šæ–­è½åœ°åˆ° LLM æµå¼æ¨ç†** â€”â€” äº‘ç«¯ä¸å†ç›²ç›®â€œç‹‚é£™â€ tokenï¼Œæ ¹æ®é“¾è·¯è´¨é‡å®æ—¶è°ƒèŠ‚ç”Ÿæˆé€Ÿç‡ï¼Œåšåˆ°â€œç½‘é€Ÿèƒ½ä¼ å¤šå°‘ï¼Œå°±ç”Ÿæˆå¤šå°‘â€ã€‚

[![eBPF](https://img.shields.io/badge/Linux-eBPF-orange.svg)](https://ebpf.io/) [![Python](https://img.shields.io/badge/Python-3.8%2B-blue.svg)](https://www.python.org/) [![AI](https://img.shields.io/badge/Model-GB%20Forecaster%20%2B%20IForest-green.svg)](https://scikit-learn.org/) [![Dashboard](https://img.shields.io/badge/LLM-Token%20Pacing-purple.svg)]()

## 1ï¸âƒ£ è¿™æ˜¯ä¸€ä¸ªä»€ä¹ˆé¡¹ç›®ï¼Ÿ

ä¼ ç»Ÿ LLM äº‘ç«¯æ¨ç†çš„ token ç”Ÿæˆé€Ÿç‡å›ºå®šï¼Œå®¢æˆ·ç«¯ç½‘ç»œå´æ—¶å¿«æ—¶æ…¢ï¼šå½“é“¾è·¯æŠ–åŠ¨æˆ–ååä¸‹é™æ—¶ï¼Œäº‘ç«¯ä¼šâ€œè¿‡åº¦ç”Ÿäº§â€è€Œè¢«è¿«ä¸¢å¼ƒ/ç­‰å¾…ï¼Œç®—åŠ›ä¸å¸¦å®½åŒé‡æµªè´¹ã€‚**NetDiag-LLM** å°†ç½‘ç»œå¼‚å¸¸æ£€æµ‹ä¸ LLM æµå¼ç”Ÿæˆè€¦åˆï¼š

1. **eBPF æ•°æ®é¢**ï¼šåœ¨å†…æ ¸æŒ‚è½½æ¢é’ˆï¼Œç§’çº§é‡‡é›† TCP RTTã€é‡ä¼ ç­‰çœŸå®æŒ‡æ ‡ï¼Œç”Ÿæˆå¹²å‡€çš„ `net_data.csv`ã€‚  
2. **AI æ™ºèƒ½é¢**ï¼šæ–°å¢ **Gradient Boosting æœªæ¥å¥åº·åº¦é¢„æµ‹**ï¼ˆåŸºäº RTT/é‡ä¼ çš„æ—¶é—´çª—æ»åç‰¹å¾ï¼‰+ ä¼ ç»Ÿ Isolation Forest åŒæ¨¡ï¼Œæ—¢èƒ½è¯†åˆ«å¼‚å¸¸ï¼Œä¹Ÿèƒ½æå‰é¢„åˆ¤â€œä¸‹ä¸€ç§’é“¾è·¯è´¨é‡â€ã€‚
3. **LLM ä¾§è¾¹è½¦**ï¼š`adaptive_token_pacer.py` å°†è§‚æµ‹å¥åº·åº¦ä¸â€œä¸‹ä¸€æ­¥é¢„æµ‹â€é€šè¿‡ S å‹æ˜ å°„èåˆä¸º **token/s å»ºè®®å€¼**ï¼Œå¹¶é€šè¿‡ HTTP Hint Server ä¾›äº‘ç«¯/è¾¹ç¼˜èŠ‚ç‚¹è½®è¯¢ï¼Œç›´æ¥æ§åˆ¶ç”Ÿæˆå¾ªç¯çš„ä¼‘çœ èŠ‚å¥ã€‚

> è¯¾å ‚ Demo çš„è¯æœ¯ï¼š*â€œæˆ‘ä»¬è®©å¤§æ¨¡å‹æ ¹æ®å®æ—¶ç½‘ç»œâ€˜è¸©åˆ¹è½¦â€™æˆ–â€˜åŠ é€Ÿâ€™ï¼Œé¿å…äº‘ç«¯ç©ºè½¬ï¼Œæå‡ç«¯åˆ°ç«¯ä½“éªŒå’Œèµ„æºåˆ©ç”¨ç‡ã€‚â€*

---

## 2ï¸âƒ£ é¡¹ç›®ç»“æ„é€Ÿè§ˆ

```text
SmartNetDiag/
â”œâ”€â”€ smart_agent.py            # eBPF æ¢é’ˆï¼šé‡‡é›† RTT/é‡ä¼ ï¼Œæ»šåŠ¨èšåˆå†™å…¥ CSV
â”œâ”€â”€ train_model.py            # åŒæ¨¡è®­ç»ƒï¼šIsolation Forest å¼‚å¸¸æ£€æµ‹ + GB æœªæ¥å¥åº·åº¦é¢„æµ‹
â”œâ”€â”€ dashboard.py              # Streamlit å®æ—¶ä»ªè¡¨ç›˜ï¼ˆå±•ç¤º RTT/é‡ä¼ /å¼‚å¸¸ç¯ï¼‰
â”œâ”€â”€ adaptive_token_pacer.py   # LLM ä¾§è¾¹è½¦ï¼šæŒ‰ç½‘ç»œåŠ¨æ€èŠ‚æµ token ç”Ÿæˆï¼›æ”¯æŒ HTTP Hint Server
â”œâ”€â”€ run_experiment.sh         # ä¸€é”®è„šæœ¬ï¼šé‡‡é›† + èƒŒæ™¯æµé‡ + æ•…éšœæ³¨å…¥
â”œâ”€â”€ chaos_maker.py            # åŸºäº tc çš„å»¶è¿Ÿ/ä¸¢åŒ…æ³¨å…¥å™¨
â”œâ”€â”€ visualize_data.py         # ç®€å•æ•°æ®åˆ†å¸ƒå¯è§†åŒ–
â””â”€â”€ README.md                 # æœ¬è¯´æ˜
```

---

## 3ï¸âƒ£ ä¸ºä»€ä¹ˆèƒ½å¸å¼•è€å¸ˆï¼Ÿï¼ˆäº®ç‚¹å–ç‚¹ï¼‰

* **ç½‘ç»œ Ã— å¤§æ¨¡å‹çš„è·¨å±‚åˆ›æ–°**ï¼šæŠŠ eBPF çš„é“¾è·¯æ´å¯Ÿç›´æ¥é©±åŠ¨ LLM æµå¼ç”Ÿæˆé€Ÿç‡ï¼Œè§£å†³â€œç®—åŠ›ç©ºè½¬ã€å¸¦å®½æµªè´¹â€è¿™ä¸€æ–°ç—›ç‚¹ã€‚  
* **å®æ—¶ã€é›¶ä¾µå…¥**ï¼šeBPF é‡‡é›†æ— éœ€æ”¹åº”ç”¨ä»£ç ï¼›Hint Server ç”¨ HTTP/JSON æš´éœ²é€Ÿç‡å»ºè®®ï¼Œæ¨ç†å¾ªç¯å‡ è¡Œä»£ç å³å¯æ¥å…¥ã€‚  
* **å¯è§†åŒ–+å¯å¤ç°**ï¼šä»ªè¡¨ç›˜å®æ—¶çœ‹ RTT/é‡ä¼ ä¸å¼‚å¸¸ç¯ï¼›è®­ç»ƒè¿‡ç¨‹ä¿ç•™å¯è§†åŒ– `model_result.png` å’ŒæŒ‡æ ‡ `training_metrics.json`ã€‚  
* **è¯¾å ‚æ¼”ç¤ºå‹å¥½**ï¼šè‡ªå¸¦æ•…éšœæ³¨å…¥è„šæœ¬ï¼Œèƒ½åœ¨ 3~5 åˆ†é’Ÿå†…å¤ç°â€œé“¾è·¯æŠ–åŠ¨ â†’ token è‡ªåŠ¨é™é€Ÿâ€çš„å®Œæ•´é—­ç¯ã€‚

---

## 4ï¸âƒ£ å¿«é€Ÿå¼€å§‹ï¼š5 åˆ†é’Ÿè·‘é€šâ€œç½‘ç»œæ„ŸçŸ¥çš„ LLMâ€

### ç¯å¢ƒå‡†å¤‡
* **OS**ï¼šUbuntu 20.04/22.04ï¼ˆç‰©ç†æœº/è™šæ‹Ÿæœº/WSL2ï¼‰
* **å†…æ ¸**ï¼š>= 5.8ï¼Œéœ€å®‰è£… BCC/eBPF å·¥å…·é“¾ï¼ˆ`bpfcc-tools`ã€`libbpfcc-dev` ç­‰ï¼‰
* **Python ä¾èµ–**ï¼š`pip3 install -r requirements.txt`

### æ­¥éª¤ Aï¼šé‡‡é›†çœŸå®é“¾è·¯æŒ‡æ ‡
```bash
sudo python3 smart_agent.py \
  --interval 0.5 \
  --window 60 \
  --csv /tmp/net_data.csv \
  --max-samples 8000
```
* è¾“å‡ºåˆ—å« **min/max/avg/p95 RTTã€é‡ä¼ è®¡æ•°** ä¸æ»šåŠ¨å¹³æ»‘åˆ—ï¼Œæ–¹ä¾¿åç»­ç‰¹å¾ä½¿ç”¨ã€‚

### æ­¥éª¤ Bï¼šè®­ç»ƒæ¨¡å‹ï¼ˆå¯é€‰ï¼Œç”¨äºè¯†åˆ«å¼‚å¸¸/é¢„æµ‹æœªæ¥å¥åº·åº¦ï¼‰
```bash
# æ¨¡å¼ 1ï¼šæ— ç›‘ç£ Isolation Forest å¼‚å¸¸æ£€æµ‹
python3 train_model.py --mode iforest --data /tmp/net_data.csv --contamination 0.15 --estimators 200

# æ¨¡å¼ 2ï¼šGradient Boosting æœªæ¥å¥åº·åº¦é¢„æµ‹ï¼ˆè¾“å‡º 0~1 å¥åº·åˆ†æ•°ï¼Œé¢„åˆ¤ä¸‹ä¸€å‘¨æœŸï¼‰
python3 train_model.py --mode gb_forecast --data /tmp/net_data.csv --lags 5 --gb-estimators 400 --gb-depth 3
```
* æ¨¡å¼ 1 ç”Ÿæˆ `network_model.pkl`ï¼ˆIsolation Forest + scalerï¼‰ï¼Œæ¨¡å¼ 2 ç”Ÿæˆ `network_model.pkl`ï¼ˆå« forecaster bundleï¼‰ï¼Œå‡é™„ `model_result.png` + `training_metrics.json`ã€‚

### æ­¥éª¤ Cï¼šå¯åŠ¨ LLM Token åŒ€é€Ÿå™¨ï¼ˆä¾§è¾¹è½¦ï¼‰
```bash
# æœ¬åœ°ä¸²è”ç¤ºä¾‹ï¼šæ ¹æ®é“¾è·¯å¥åº·åº¦è°ƒæ•´ token/s
python3 adaptive_token_pacer.py "Once upon a time..." \
  --csv /tmp/net_data.csv \
  --max-tps 60 --min-tps 5 \
  --mode word

# å¦‚æœéœ€è¦ç»™äº‘ç«¯/è¾¹ç¼˜èŠ‚ç‚¹æŸ¥è¯¢ï¼Œå¯åŠ¨ HTTP Hint Server
python3 adaptive_token_pacer.py --csv /tmp/net_data.csv --serve 9000 --max-tps 80
```
æœåŠ¡å™¨ç«¯ï¼ˆæ¨ç†å¾ªç¯ï¼‰åªéœ€å®šæœŸè½®è¯¢ï¼š
```python
import requests, time
while True:
    hint = requests.get("http://<pacer_host>:9000", timeout=0.2).json()
    token = llm.generate_next()
    send_to_client(token)
    time.sleep(hint["sleep_seconds"])  # æŒ‰ç½‘ç»œå»ºè®®ä¼‘çœ ï¼Œèƒ½ä¼ å¤šå°‘å°±ç”Ÿæˆå¤šå°‘
```

### æ­¥éª¤ Dï¼šè¯¾å ‚å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰
```bash
streamlit run dashboard.py
```
* åœ¨æµè§ˆå™¨è®¿é—® `http://localhost:8501`ï¼Œå®æ—¶è§‚å¯Ÿ RTT/é‡ä¼ ä¸ AI å¼‚å¸¸ç¯ã€‚

---

## 5ï¸âƒ£ èƒŒåçš„æ ¸å¿ƒé€»è¾‘

1. **é“¾è·¯è§‚æµ‹**ï¼š`smart_agent.py` æŒ‚è½½ `tcp_rcv_established`ã€`tcp_retransmit_skb` é‡‡æ · RTT/é‡ä¼ ï¼›ç§’çº§èšåˆ + æ»‘åŠ¨çª—å£å¹³æ»‘ã€‚
2. **å¼‚å¸¸/å¥åº·åº¦ä¼°è®¡ & é¢„æµ‹**ï¼š`train_model.py` æä¾›ä¸¤ç§æ¨¡å¼â€”â€”Isolation Forest æ ‡æ³¨å¼‚å¸¸ï¼Œæˆ– GB å›å½’é¢„æµ‹ä¸‹ä¸€å‘¨æœŸå¥åº·åº¦ï¼ˆåŸºäºæ»åç‰¹å¾ï¼‰ï¼›è¾“å‡ºå¥åº·åˆ†æ•°ï¼ˆ0~1ï¼‰ã€‚
3. **é€Ÿç‡æ˜ å°„ï¼ˆé«˜çº§å¯è¡Œæ–¹æ¡ˆï¼‰**ï¼š
   * **S å‹æ˜ å°„**ï¼šå°†å¥åº·åˆ†æ•°è¿‡ S å‹æ›²çº¿è½¬æ¢ä¸º token/sï¼ˆ`knee` æ§åˆ¶â€œåˆ¹è½¦ç‚¹â€ï¼Œ`sharpness` æ§åˆ¶è¿‡æ¸¡å¹³æ»‘åº¦ï¼‰ï¼Œé¿å…å‰§çƒˆæŠ–åŠ¨ã€‚
   * **è§‚æµ‹+é¢„æµ‹èåˆ**ï¼šå®æ—¶å¥åº·åº¦ä¸â€œä¸‹ä¸€æ­¥é¢„æµ‹â€æŒ‰ `forecast_weight` èåˆï¼Œé“¾è·¯æ¶åŒ–æå‰å‡é€Ÿï¼Œæ¢å¤æ—¶å¹³æ»‘æé€Ÿã€‚
   * **Hint Server/å†…åµŒè°ƒç”¨**ï¼š`adaptive_token_pacer.py --serve` è¾“å‡º `{current_tps, sleep_seconds}`ï¼Œæ¨ç†å¾ªç¯æŒ‰å»ºè®®ä¼‘çœ å³å¯ã€‚
4. **äº‘ç«¯é€‚é…æ–¹å¼**ï¼š
   * **Hint Server è½®è¯¢**ï¼šæ¨ç†çº¿ç¨‹æ¯ 0.3~0.8s è·å– `sleep_seconds`ï¼Œç›´æ¥æ§åˆ¶ç”Ÿæˆå¾ªç¯èŠ‚å¥ã€‚
   * **å†…åµŒåº“è°ƒç”¨**ï¼šå°† pacer é€»è¾‘åµŒå…¥ä½ çš„ streaming handlerï¼ŒæŒ‰è¿”å›çš„ target token/s è‡ªé€‚åº”èŠ‚æµã€‚

---

## 6ï¸âƒ£ æ•™å­¦ Demo å‰§æœ¬ï¼ˆ3~5 åˆ†é’Ÿï¼‰

1. `sudo bash run_experiment.sh` å¯åŠ¨é‡‡é›† + èƒŒæ™¯é•¿è¿æ¥ + éšæœºå»¶è¿Ÿ/ä¸¢åŒ…æ³¨å…¥ã€‚  
2. ç»ˆç«¯ A è§‚å¯Ÿ `net_data.csv` çš„ RTT/é‡ä¼ è·³å˜ï¼›ç»ˆç«¯ B å¯åŠ¨ `adaptive_token_pacer.py --serve 9000`ã€‚  
3. åœ¨æ¨ç†ä¼ªä»£ç /Notebook ä¸­å±•ç¤º `sleep_seconds` éšæ•…éšœå¢å¤§è€Œä¸Šå‡ï¼Œtoken è¾“å‡ºè‡ªåŠ¨å˜æ…¢ã€‚  
4. ï¼ˆå¯é€‰ï¼‰åœ¨æµè§ˆå™¨æ‰“å¼€ `streamlit run dashboard.py`ï¼Œè®©è€å¸ˆçœ‹åˆ°ä»ªè¡¨ç›˜å¼‚å¸¸ç¯ä¸ Hint Server æ›²çº¿è”åŠ¨ã€‚

> ç»“å°¾é‡‘å¥ï¼š*â€œæˆ‘ä»¬ä¸å†ç›²ç›®æŠŠ token å…¨éƒ¨æ¨å‘æŠ–åŠ¨çš„é“¾è·¯ï¼Œè€Œæ˜¯è®©ç½‘ç»œçŠ¶æ€ç›´æ¥é©±åŠ¨ç”ŸæˆèŠ‚å¥ã€‚â€*

---

## 7ï¸âƒ£ å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

* **WSL2 æ‰¾ä¸åˆ°å†…æ ¸å¤´æ–‡ä»¶**ï¼šéœ€è¦æ‰‹åŠ¨ä¸‹è½½å¾®è½¯å‘å¸ƒçš„ WSL2 å†…æ ¸æºç å¹¶å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„ headersã€‚
* **Hint Server å»¶è¿Ÿ**ï¼šå»ºè®®å°† pacer éƒ¨ç½²åœ¨è·ç¦»æ¨ç†èŠ‚ç‚¹è¿‘çš„åŒæœº/åŒå­ç½‘ï¼Œè½®è¯¢é—´éš”ä¿æŒåœ¨äºšç§’çº§ã€‚
* **å¤§è§„æ¨¡éƒ¨ç½²**ï¼šå¯å°† pacer é€»è¾‘ç§»æ¤åˆ°ç½‘å…³/è¾¹ç¼˜ä»£ç†å±‚ï¼Œæˆ–ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¨é€é€Ÿç‡å»ºè®®ï¼Œç»Ÿä¸€è°ƒåº¦å¤šè·¯æµå¼è¿æ¥ã€‚

---

## 8ï¸âƒ£ License & è‡´è°¢

æœ¬é¡¹ç›®ä»…ä¾›è®¡ç®—æœºç½‘ç»œè¯¾ç¨‹å­¦ä¹ ä¸ç ”ç©¶ä½¿ç”¨ã€‚æ¬¢è¿åœ¨è¯¾å ‚/å®éªŒä¸­è‡ªç”±æ”¹é€ å¹¶æ³¨æ˜æ¥æºã€‚

